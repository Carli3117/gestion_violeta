<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tareas | Violeta Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7fb; font-family: 'Inter', 'Segoe UI', Arial, sans-serif; color: #23243a;}
        .main-header {
            background: #fff; border-radius: 0 0 18px 18px; box-shadow: 0 2px 16px #a091df18;
            padding: 1.3rem 2.5rem 1.1rem 2.5rem; margin-bottom: 2.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #ede7fb;}
        .header-title { font-weight: 700; color: #7C3AED; font-size: 2rem;}
        .btn-dashboard {
            background: linear-gradient(90deg, #7C3AED 70%, #6B21A8 100%);
            color: #fff; font-weight: 600; border: none; border-radius: 9px; padding: 0.56em 1.4em;
            font-size: 1.08rem; box-shadow: 0 2px 8px #d1bfff1a; transition: background 0.15s;
        }
        .btn-dashboard:hover { background: #6B21A8; color: #fff;}
        .container-main {
            display: flex; gap: 2.4rem; align-items: flex-start; padding: 2.5rem 1rem; max-width: 1700px; margin: 0 auto;}
        .card-form {
            background: #fff; border-radius: 16px; box-shadow: 0 4px 16px #a091df22;
            padding: 2.2rem 2.5rem; width: 440px; min-width: 400px;}
        .card-form h3 { font-weight: 700; color: #7C3AED; margin-bottom: 1.5em; text-align: center;}
        .form-label { margin-top: 1em; font-weight: 500; color: #6B21A8;}
        .form-control, .form-select {
            margin-bottom: 0.7em; border-radius: 9px; border: 1.5px solid #dbdbf7; padding: 0.63em 1em;}
        .form-control:focus, .form-select:focus { border-color: #7C3AED; box-shadow: 0 2px 12px #d6ccff33;}
        .btn-violeta {
            background: linear-gradient(90deg, #7C3AED 70%, #6B21A8 100%);
            border: none; color: #fff; font-weight: 600; border-radius: 9px; padding: 0.67em 1.7em;
            transition: background 0.13s; margin-top: 1em;}
        .btn-violeta:hover { background: #6B21A8;}
        .kanban-panel {
            flex: 1; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #bcb5eb21; padding: 2.2rem 2.1rem;}
        .kanban-panel h4 { color: #7C3AED; font-weight: 700; margin-bottom: 1.4em;}
        .kanban-proyecto { margin-bottom: 2.2em;}
        .kanban-proyecto h5 { color: #6B21A8; font-weight: 700; margin-bottom: 0.7em; font-size: 1.19em;}
        .tareas-list { display: flex; flex-direction: column; gap: 1.18em;}
        .tarea-card {
            background: #f6f1fd; border-left: 8px solid #7C3AED; border-radius: 9px; padding: 1em 1.5em 0.8em 1.5em;
            box-shadow: 0 2px 8px #d6ccff2c; position: relative; margin-bottom: .7em;}
        .tarea-card .tarea-titulo { font-size: 1.13em; font-weight: 700; color: #6B21A8; margin-bottom: .4em;}
        .tarea-card .tarea-meta { font-size: .96em; color: #8f7ac4; margin-bottom: .15em;}
        .tarea-card .tarea-descripcion { color: #3a2a55; font-size: .98em; margin-bottom: .25em;}
        .tarea-card .badge { font-size: .86em; margin-right: 0.6em;}
        .tarea-card .estado {
            position: absolute; right: 1.1em; top: 1em; padding: .2em 1em; border-radius: 9px;
            font-size: .93em; background: #e7dcfb; color: #6B21A8; font-weight: 600;}
        .tarea-card .estado[style] { color: #fff !important;}
        .tarea-card .adjunto-block img {
            max-height: 36px; max-width: 70px; border-radius: 5px; box-shadow: 0 2px 10px #0001;}
        .tarea-card .adjunto-block { margin-top: 10px; display: flex; align-items: center; gap: 10px;}
        .toast-violeta {
            background: linear-gradient(90deg, #7C3AED 70%, #6B21A8 100%);
            color: #fff; font-weight: 500; font-size: 1.1em; border-radius: 12px; box-shadow: 0 4px 18px #a091df44;}
        .toast-violeta .btn-close { filter: invert(1);}
        @media (max-width: 1100px) {
            .container-main { flex-direction: column;}
            .card-form, .kanban-panel { width: 100%; min-width: unset; margin-bottom: 2.2em;}
        }
    </style>
</head>
<body>
<div class="main-header">
    <div class="header-title"><i class="bi bi-stars"></i> Violeta Workspace</div>
    <a href="{{ url_for('usuario.dashboard') }}" class="btn btn-dashboard">
        <i class="bi bi-arrow-left"></i> Volver al Dashboard
    </a>
</div>
<div class="container-main">
    <!-- PANEL DE REGISTRO DE NUEVA TAREA -->
    <form class="card-form" method="POST" action="{{ url_for('tarea.nueva_tarea') }}" enctype="multipart/form-data" id="formTarea">
        <h3><i class="bi bi-plus-circle"></i> Nueva Tarea</h3>
        <label class="form-label" for="idproyecto">Proyecto</label>
        <select class="form-select" id="idproyecto" name="idproyecto" required onchange="autoFillUsuarioYFecha()">
            <option value="">Seleccionar proyecto</option>
            {% for proyecto in proyectos %}
                <option value="{{ proyecto.idproyecto }}">{{ proyecto.nombre_proyecto }}</option>
            {% endfor %}
        </select>
        <label class="form-label" for="usuarioAsignadoNombre">Usuario asignado</label>
        <input type="hidden" id="idusuarioAsignado" name="idusuario_asignado" required>
        <input type="text" class="form-control" id="usuarioAsignadoNombre" readonly placeholder="Seleccione un proyecto">
        <label class="form-label" for="fecha_creacion">Fecha de inicio</label>
        <input type="date" class="form-control" id="fechaCreacion" name="fecha_creacion" readonly required>
        <label class="form-label" for="fecha_limite">Fecha límite</label>
        <input type="date" class="form-control" id="fechaLimite" name="fecha_limite">
        <label class="form-label" for="titulo">Título</label>
        <input type="text" class="form-control" id="titulo" name="titulo" maxlength="120" required>
        <label class="form-label" for="descripcion">Descripción</label>
        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
        <label class="form-label" for="idtipo_tarea">Tipo de tarea</label>
        <select class="form-select" id="idtipo_tarea" name="idtipo_tarea" required>
            <option value="">Seleccionar tipo</option>
            {% for tipo in tipos_tarea %}
                <option value="{{ tipo.idtipo_tarea }}">{{ tipo.nombre_tipo }}</option>
            {% endfor %}
        </select>
        <label class="form-label" for="idprioridad">Prioridad</label>
        <select class="form-select" id="idprioridad" name="idprioridad" required>
            <option value="">Seleccionar prioridad</option>
            {% for prioridad in prioridades %}
                <option value="{{ prioridad.idprioridad }}">{{ prioridad.nombre_prioridad }}</option>
            {% endfor %}
        </select>
        <label class="form-label" for="idestado">Estado inicial</label>
        <select class="form-select" id="idestado" name="idestado" required>
            <option value="">Seleccionar estado</option>
            {% for estado in estados %}
                <option value="{{ estado.idestado }}">{{ estado.nombre_estado }}</option>
            {% endfor %}
        </select>
        <label class="form-label" for="adjunto">Adjuntar archivo</label>
        <input type="file" class="form-control" id="adjunto" name="adjunto" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt">
        <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="enviar_notificacion" id="enviarNotificacion" checked>
            <label class="form-check-label" for="enviarNotificacion">
                Enviar notificación automática
            </label>
        </div>
        <button type="submit" class="btn btn-violeta w-100 mt-3"><i class="bi bi-save"></i> Guardar Tarea</button>
    </form>
    <div class="flex-grow-1 ms-3">
        <!-- PANEL DE FILTRO POR PROYECTO Y TAREA -->
        <div class="row mb-4 align-items-end">
            <div class="col-md-4">
                <label class="form-label" for="filtroProyecto"><i class="bi bi-folder"></i> Filtrar por Proyecto</label>
                <select class="form-select" id="filtroProyecto">
                    <option value="">Todos los proyectos</option>
                    {% for proyecto in proyectos %}
                        <option value="{{ proyecto.nombre_proyecto }}">{{ proyecto.nombre_proyecto }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label" for="filtroTarea"><i class="bi bi-list-task"></i> Filtrar por Tarea</label>
                <select class="form-select" id="filtroTarea" disabled>
                    <option value="">Seleccione un proyecto primero</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-violeta w-100" id="btnFiltrarTareas" type="button">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <button class="btn btn-secondary w-100 mt-2" id="btnResetFiltro" type="button" style="display:none;">
                    <i class="bi bi-x-circle"></i> Limpiar Filtro
                </button>
            </div>
        </div>
        <!-- PANEL KANBAN DE TAREAS PENDIENTES -->
        <div class="kanban-panel">
            <h4><i class="bi bi-kanban"></i> Tareas Pendientes por Proyecto</h4>
            <div id="tareasPendientes">
                {% for proyecto, tareas_grupo in tareas_por_proyecto.items() %}
                    <div class="kanban-proyecto" data-proyecto="{{ proyecto }}">
                        <h5><i class="bi bi-folder"></i> {{ proyecto }}</h5>
                        <div class="tareas-list">
                            {% for tarea in tareas_grupo %}
                            <div class="tarea-card" data-tarea="{{ tarea.titulo }}">
                                <div class="tarea-titulo">{{ tarea.titulo }}</div>
                                <div class="tarea-meta">
                                    Asignado a: <b>{{ tarea.usuario_asignado.nombre if tarea.usuario_asignado else '' }}</b>
                                </div>
                                <div class="tarea-descripcion">{{ tarea.descripcion }}</div>
                                <!-- ========== BLOQUE DE ADJUNTO ========== -->
                                {% if tarea.adjunto %}
                                    <div class="adjunto-block">
                                        {% set tipo = tarea.adjunto.tipo or '' %}
                                        {% set es_imagen = 'image' in tipo %}
                                        {% set es_pdf = tipo == 'application/pdf' %}
                                        {% set es_word = tipo in ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] %}
                                        {% set es_excel = tipo in ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'] %}
                                        <span class="badge bg-light text-dark">
                                            <i class="bi bi-paperclip"></i> Archivo adjunto:
                                        </span>
                                        {% if es_imagen %}
                                            <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}" target="_blank">
                                                <img src="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}"
                                                     alt="Imagen adjunta">
                                            </a>
                                        {% elif es_pdf %}
                                            <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}" target="_blank" class="ms-2">
                                                <i class="bi bi-file-pdf text-danger" style="font-size:1.5em;"></i> PDF
                                            </a>
                                        {% elif es_word %}
                                            <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}" target="_blank" class="ms-2">
                                                <i class="bi bi-file-earmark-word text-primary" style="font-size:1.5em;"></i> Word
                                            </a>
                                        {% elif es_excel %}
                                            <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}" target="_blank" class="ms-2">
                                                <i class="bi bi-file-earmark-excel text-success" style="font-size:1.5em;"></i> Excel
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}" target="_blank" class="ms-2">
                                                <i class="bi bi-file-earmark" style="font-size:1.5em;"></i> Archivo
                                            </a>
                                        {% endif %}
                                        <a href="{{ url_for('tarea.descargar_adjunto', idadjunto=tarea.adjunto.idadjunto) }}"
                                           class="btn btn-outline-secondary btn-sm ms-2" target="_blank" title="Descargar adjunto">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                {% endif %}
                                <!-- ========== FIN BLOQUE DE ADJUNTO ========== -->
                                <span class="badge" style="background: {{ tarea.prioridad.color if tarea.prioridad and tarea.prioridad.color else '#a386e6' }}; color: #fff;">
                                    {{ tarea.prioridad.nombre_prioridad if tarea.prioridad else 'Sin Prioridad' }}
                                </span>
                                <span class="estado" style="background: {{ tarea.estado.color if tarea.estado and tarea.estado.color else '#d3bfff' }};">
                                    {{ tarea.estado.nombre_estado if tarea.estado else 'Sin Estado' }}
                                </span>
                                <span class="badge bg-light text-dark">{{ tarea.fecha_limite.strftime('%d-%m-%Y') if tarea.fecha_limite else '' }}</span>
                                <!-- BOTÓN PARA VER COMENTARIOS -->
                                <a href="{{ url_for('comentario.vista_comentarios', idproyecto=tarea.idproyecto, idtarea=tarea.idtarea) }}"
                                   class="btn btn-outline-primary btn-sm mt-2 w-100">
                                    <i class="bi bi-chat-dots"></i> Ver Comentarios de esta tarea
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if not tareas_por_proyecto %}
                <div class="alert alert-info">No hay tareas pendientes.</div>
            {% endif %}
        </div>
    </div>
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1200">
      <div class="toast align-items-center toast-violeta show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-check-circle-fill"></i> {{ messages[0] }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
    </div>
  {% endif %}
{% endwith %}

<script>
    // Serializa los datos desde el backend
    var proyectos = {{ proyectos_json | tojson }};
    var usuarios = {{ usuarios_json | tojson }};
    // Rellena el usuario asignado (ID y nombre) y la fecha
    function autoFillUsuarioYFecha() {
        var selectProyecto = document.getElementById('idproyecto');
        var usuarioInputId = document.getElementById('idusuarioAsignado');
        var usuarioInputNombre = document.getElementById('usuarioAsignadoNombre');
        var fechaInput = document.getElementById('fechaCreacion');
        var idproyecto = selectProyecto.value;

        var proyecto = proyectos.find(p => p.idproyecto == idproyecto);
        if (proyecto) {
            var usuario = usuarios.find(u => u.idusuario == proyecto.idusuario);
            usuarioInputId.value = usuario ? usuario.idusuario : '';
            usuarioInputNombre.value = usuario ? usuario.nombre : '';
            fechaInput.value = proyecto.fecha_creacion || '';
        } else {
            usuarioInputId.value = '';
            usuarioInputNombre.value = '';
            fechaInput.value = '';
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var tareasPorProyecto = {{ tareas_por_proyecto_json | tojson }};
    const filtroProyecto = document.getElementById('filtroProyecto');
    const filtroTarea = document.getElementById('filtroTarea');
    const btnFiltrarTareas = document.getElementById('btnFiltrarTareas');
    const btnResetFiltro = document.getElementById('btnResetFiltro');

    filtroProyecto.addEventListener('change', function() {
        let nombreProyecto = this.value;
        filtroTarea.innerHTML = '';
        if (nombreProyecto && tareasPorProyecto[nombreProyecto]) {
            filtroTarea.disabled = false;
            let tareas = tareasPorProyecto[nombreProyecto];
            let optionAll = document.createElement('option');
            optionAll.value = '';
            optionAll.text = 'Todas las tareas';
            filtroTarea.appendChild(optionAll);
            tareas.forEach(t => {
                let option = document.createElement('option');
                option.value = t.titulo;
                option.text = t.titulo;
                filtroTarea.appendChild(option);
            });
        } else {
            filtroTarea.disabled = true;
            let option = document.createElement('option');
            option.value = '';
            option.text = 'Seleccione un proyecto primero';
            filtroTarea.appendChild(option);
        }
    });

    btnFiltrarTareas.addEventListener('click', function() {
        let nombreProyecto = filtroProyecto.value;
        let tituloTarea = filtroTarea.value;
        document.querySelectorAll('.kanban-proyecto').forEach(div => { div.style.display = 'none'; });
        if (!nombreProyecto) {
            document.querySelectorAll('.kanban-proyecto').forEach(div => {
                div.style.display = '';
                div.querySelectorAll('.tarea-card').forEach(tc => tc.style.display = '');
            });
            btnResetFiltro.style.display = 'none';
            return;
        }
        let proyectoDiv = document.querySelector('.kanban-proyecto[data-proyecto="' + nombreProyecto.replace(/"/g,'\\"') + '"]');
        if (proyectoDiv) {
            proyectoDiv.style.display = '';
            proyectoDiv.querySelectorAll('.tarea-card').forEach(tc => {
                if (!tituloTarea || tc.getAttribute('data-tarea') === tituloTarea) {
                    tc.style.display = '';
                } else {
                    tc.style.display = 'none';
                }
            });
        }
        btnResetFiltro.style.display = '';
    });

    btnResetFiltro.addEventListener('click', function() {
        filtroProyecto.value = '';
        filtroTarea.innerHTML = '<option value="">Seleccione un proyecto primero</option>';
        filtroTarea.disabled = true;
        document.querySelectorAll('.kanban-proyecto').forEach(div => {
            div.style.display = '';
            div.querySelectorAll('.tarea-card').forEach(tc => tc.style.display = '');
        });
        btnResetFiltro.style.display = 'none';
    });
</script>
</body>
</html>
